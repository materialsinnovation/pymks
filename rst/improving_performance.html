

<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Improving Performance &mdash; PyMKS</title>
    
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootswatch-3.1.0/cosmo/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pymks.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.1-dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.1.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="shortcut icon" href="../_static/pymks_logo.ico"/>
    <link rel="top" title="PyMKS" href="../index.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body>


  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html"><img src="../_static/pymks_logo.png">
           </a>
        <span class="navbar-text navbar-version pull-left"><b>0.1-dev</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
                <li><a href="INSTALLATION.html">Installation</a></li>
                <li><a href="../EXAMPLES.html">Examples</a></li>
                <li><a href="../API.html">API</a></li>
                <li><a href="https://github.com/openmaterials/pymks/">Github</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">More <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../THEORY.html">Theory</a><ul>
<li class="toctree-l2"><a class="reference internal" href="derivation.html">Derivation of Materials Knowledge Systems Equation using Linear Elasticity</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="CREDITS.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="LICENSE.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="CITATION.html">Citing</a></li>
<li class="toctree-l1"><a class="reference internal" href="REQUIREMENTS.html">Requirements</a></li>
</ul>
</ul>
</li>
              
            
            
            
            
            
          </ul>

          

        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      
  <div class="section" id="improving-performance">
<h1>Improving Performance<a class="headerlink" href="#improving-performance" title="Permalink to this headline">¶</a></h1>
<p>This notebook will</p>
<ul class="simple">
<li>introduce parallel computing with IPython,</li>
<li>cross-validate in parallel,</li>
<li>introduce <tt class="docutils literal"><span class="pre">numexpr</span></tt> for improving the efficiency of <tt class="docutils literal"><span class="pre">numpy</span></tt>,</li>
<li>improve the efficiency of the FFT with <tt class="docutils literal"><span class="pre">PyFFTW</span></tt>,</li>
<li>implement this all in the <tt class="docutils literal"><span class="pre">FastMKSRegressionModel</span></tt> class and</li>
<li>run a full Cahn-Hilliard probelm with the <tt class="docutils literal"><span class="pre">FastMKSRegressionModel</span></tt>.</li>
</ul>
<div class="code python highlight-python"><pre>%matplotlib inline
%load_ext autoreload
%autoreload 2

import numpy as np
import matplotlib.pyplot as plt


from pymks import MKSRegressionModel
from pymks import FastMKSRegressionModel
from pymks import FiPyCHModel
from sklearn import metrics
from sklearn.grid_search import GridSearchCV
from pymks import FastMKSRegressionModel
import numexpr

mse = metrics.mean_squared_error</pre>
</div>
<div class="highlight-python"><pre>The autoreload extension is already loaded. To reload it, use:
  %reload_ext autoreload</pre>
</div>
<div class="section" id="parallel-data-generation">
<h2>Parallel Data Generation<a class="headerlink" href="#parallel-data-generation" title="Permalink to this headline">¶</a></h2>
<p>Generate a large(r) amount of data.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">101</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">21</span><span class="p">))</span>
</pre></div>
</div>
<p>Create a &#8220;direct view&#8221; of the engines.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">IPython.parallel</span> <span class="kn">import</span> <span class="n">Client</span>
<span class="n">engines</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>
<span class="n">dview</span> <span class="o">=</span> <span class="n">engines</span><span class="p">[:]</span>
<span class="n">dview</span><span class="o">.</span><span class="n">block</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">dview</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>
<span class="k">print</span> <span class="s">&quot;engines IDs&quot;</span><span class="p">,</span><span class="n">engines</span><span class="o">.</span><span class="n">ids</span>
</pre></div>
</div>
<div class="highlight-python"><pre>engines IDs [0, 1, 2, 3, 4, 5, 6, 7]</pre>
</div>
<p>scatter the data.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">dview</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="s">&#39;X&#39;</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
</pre></div>
</div>
<p>Perfom the calculation in parallel.</p>
<div class="code python highlight-python"><pre>%px print X.shape</pre>
</div>
<div class="highlight-python"><pre>[stdout:0] (125, 21, 21)
[stdout:1] (125, 21, 21)
[stdout:2] (125, 21, 21)
[stdout:3] (125, 21, 21)
[stdout:4] (125, 21, 21)
[stdout:5] (125, 21, 21)
[stdout:6] (125, 21, 21)
[stdout:7] (125, 21, 21)</pre>
</div>
<div class="code python highlight-python"><pre>%%px

from pymks import FiPyCHMode
y = FiPyCHModel().predict(X)</pre>
</div>
<p>The <tt class="docutils literal"><span class="pre">map_sync</span></tt> function returns a list which needs to be concatenated
into one array.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">y</span> <span class="o">=</span> <span class="n">dview</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">)</span>
<span class="k">print</span> <span class="n">y</span><span class="o">.</span><span class="n">dtype</span>
<span class="k">print</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="n">float64</span>
<span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">21</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="parallel-cross-validation">
<h2>Parallel Cross-Validation<a class="headerlink" href="#parallel-cross-validation" title="Permalink to this headline">¶</a></h2>
<p>Partition the data into training and test arrays.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sklearn.cross_validation</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<p>Create a dictionary of tuning parameters to search and define the
optimization function.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">Nbins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<p>Setting <tt class="docutils literal"><span class="pre">n_jobs=-1</span></tt> uses all the available processors</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">pymks</span> <span class="kn">import</span> <span class="n">MKSRegressionModel</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">metrics</span>
<span class="kn">from</span> <span class="nn">sklearn.grid_search</span> <span class="kn">import</span> <span class="n">GridSearchCV</span>
<span class="n">tuning_parameters</span> <span class="o">=</span> <span class="p">[{</span><span class="s">&#39;Nbin&#39;</span><span class="p">:</span> <span class="n">Nbins</span><span class="p">}]</span>

<span class="k">def</span> <span class="nf">neg_mse</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">metrics</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">mean_squared_error</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">mse</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

<span class="n">gridSearch</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">MKSRegressionModel</span><span class="p">(),</span> <span class="n">tuning_parameters</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                          <span class="n">score_func</span><span class="o">=</span><span class="n">neg_mse</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">out</span> <span class="o">=</span> <span class="n">gridSearch</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="k">print</span> <span class="n">gridSearch</span><span class="o">.</span><span class="n">best_estimator_</span>
<span class="n">gridSearch</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="n">MKSRegressionModel</span><span class="p">(</span><span class="n">Nbin</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="mf">0.99998973068237618</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="k">for</span> <span class="n">params</span><span class="p">,</span> <span class="n">mean_score</span><span class="p">,</span> <span class="n">scores</span> <span class="ow">in</span> <span class="n">gridSearch</span><span class="o">.</span><span class="n">grid_scores_</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%1.3e</span><span class="s"> (+/-</span><span class="si">%1.3e</span><span class="s">) for </span><span class="si">%r</span><span class="s">&quot;</span><span class="o">%</span> <span class="p">(</span><span class="n">mean_score</span><span class="p">,</span> <span class="n">scores</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="k">for</span> <span class="n">Nbin</span> <span class="ow">in</span> <span class="n">Nbins</span><span class="p">:</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">MKSRegressionModel</span><span class="p">(</span><span class="n">Nbin</span><span class="o">=</span><span class="n">Nbin</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span> <span class="o">=</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&#39;Nbin: {0}, mse: {1:1.3e}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Nbin</span><span class="p">,</span> <span class="n">mse</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="exercise-06-0">
<h2>Exercise 06-0<a class="headerlink" href="#exercise-06-0" title="Permalink to this headline">¶</a></h2>
<p>Change the number of samples. How does the optimal <tt class="docutils literal"><span class="pre">Nbin</span></tt> change with
number of samples?</p>
<p>Evaluate time taken for <tt class="docutils literal"><span class="pre">gridSearch.fit</span></tt> for varying <tt class="docutils literal"><span class="pre">n_jobs</span></tt>.</p>
</div>
<div class="section" id="evaluate-the-mean-square-error-while-varying-nspace-in-parallel-todo">
<h2>Evaluate the mean square error while varying Nspace in parallel (todo)<a class="headerlink" href="#evaluate-the-mean-square-error-while-varying-nspace-in-parallel-todo" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="numexpr">
<h2>Numexpr<a class="headerlink" href="#numexpr" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference external" href="http://code.google.com/p/numexpr/">Numexpr</a> package speeds up
<tt class="docutils literal"><span class="pre">numpy</span></tt> calculations considerably. For example, take the following</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">102</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mf">1e7</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mf">1e7</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mf">1e7</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">dtype</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="n">dtype</span><span class="p">(</span><span class="s">&#39;float64&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">%timeit</span></tt> magic implicitly handles a number of common pit falls
when timing Python expression execution.</p>
<div class="code python highlight-python"><pre>?%timeit</pre>
</div>
<p>Use <tt class="docutils literal"><span class="pre">timeit</span></tt> to time a regular Numpy calculation.</p>
<div class="code python highlight-python"><pre>d = a**2 + b**2 + 2*a*b
%timeit a**2 + b**2 + 2*a*b</pre>
</div>
<div class="highlight-python"><pre>10 loops, best of 3: 194 ms per loop</pre>
</div>
<p>Numpy calculations are quite slow when compared with the same code in C.
This is due to the overhead from memory allocation for the intermediate
arrays.</p>
<p>Use <tt class="docutils literal"><span class="pre">timeit</span></tt> to time a
<tt class="docutils literal"><span class="pre">`numexpr</span></tt> &lt;<a class="reference external" href="http://code.google.com/p/numexpr/">http://code.google.com/p/numexpr/</a>&gt;`__ calculation.</p>
<div class="code python highlight-python"><pre>e = numexpr.evaluate('a**2 + b**2 + 2 * a * b')
%timeit e = numexpr.evaluate('a**2 + b**2 + 2 * a * b')</pre>
</div>
<div class="highlight-python"><pre>10 loops, best of 3: 20.1 ms per loop</pre>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">d</span> <span class="o">==</span> <span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="bp">True</span>
</pre></div>
</div>
<p>There is no benefit for small expressions with no intermediate memory
allocation.</p>
<div class="code python highlight-python"><pre>%timeit a**2</pre>
</div>
<div class="highlight-python"><pre>10 loops, best of 3: 29.6 ms per loop</pre>
</div>
<div class="code python highlight-python"><pre>numexpr.set_num_threads(8)
%timeit numexpr.evaluate("a**2")</pre>
</div>
<div class="highlight-python"><pre>100 loops, best of 3: 15.4 ms per loop</pre>
</div>
<p><a class="reference external" href="http://code.google.com/p/numexpr/">Numexpr</a> uses multithreading by
default.</p>
<div class="code python highlight-python"><pre>Nproc = 8
for Nthread in range(1, Nproc + 1):
    print "number of threads:",Nthread
    numexpr.set_num_threads(Nthread)
    %timeit numexpr.evaluate('a**2 + b**2 + 2 * a * b')</pre>
</div>
<div class="highlight-python"><pre>number of threads: 1
10 loops, best of 3: 65.3 ms per loop
number of threads: 2
10 loops, best of 3: 46.9 ms per loop
number of threads: 3
10 loops, best of 3: 32.6 ms per loop
number of threads: 4
10 loops, best of 3: 25.1 ms per loop
number of threads: 5
10 loops, best of 3: 27.7 ms per loop
number of threads: 6
10 loops, best of 3: 24.9 ms per loop
number of threads: 7
10 loops, best of 3: 24.4 ms per loop
number of threads: 8
10 loops, best of 3: 21.3 ms per loop</pre>
</div>
<p>Another example.</p>
<div class="code python highlight-python"><pre>%timeit sin(a)**2 + cos(b)**2</pre>
</div>
<div class="highlight-python"><pre>---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)

&lt;ipython-input-67-40e67b41ad0a&gt; in &lt;module&gt;()
----&gt; 1 get_ipython().magic(u'timeit sin(a)**2 + cos(b)**2')


/home/wd15/git/ipython/IPython/core/interactiveshell.pyc in magic(self, arg_s)
   2181         magic_name, _, magic_arg_s = arg_s.partition(' ')
   2182         magic_name = magic_name.lstrip(prefilter.ESC_MAGIC)
-&gt; 2183         return self.run_line_magic(magic_name, magic_arg_s)
   2184
   2185     #-------------------------------------------------------------------------


/home/wd15/git/ipython/IPython/core/interactiveshell.pyc in run_line_magic(self, magic_name, line)
   2102                 kwargs['local_ns'] = sys._getframe(stack_depth).f_locals
   2103             with self.builtin_trap:
-&gt; 2104                 result = fn(*args,**kwargs)
   2105             return result
   2106


/home/wd15/git/ipython/IPython/core/magics/execution.pyc in timeit(self, line, cell)


/home/wd15/git/ipython/IPython/core/magic.pyc in &lt;lambda&gt;(f, *a, **k)
    189     # but it's overkill for just that one bit of state.
    190     def magic_deco(arg):
--&gt; 191         call = lambda f, *a, **k: f(*a, **k)
    192
    193         if callable(arg):


/home/wd15/git/ipython/IPython/core/magics/execution.pyc in timeit(self, line, cell)
    984             number = 1
    985             for _ in range(1, 10):
--&gt; 986                 if timer.timeit(number) &gt;= 0.2:
    987                     break
    988                 number *= 10


/usr/lib/python2.7/timeit.pyc in timeit(self, number)
    193         gc.disable()
    194         try:
--&gt; 195             timing = self.inner(it, self.timer)
    196         finally:
    197             if gcold:


&lt;magic-timeit&gt; in inner(_it, _timer)


ValueError: operands could not be broadcast together with shapes (1024,16384) (10000000)</pre>
</div>
<div class="code python highlight-python"><pre>%timeit numexpr.evaluate('sin(a)**2 + cos(b)**2')</pre>
</div>
</div>
<div class="section" id="pyfftw">
<h2>PyFFTW<a class="headerlink" href="#pyfftw" title="Permalink to this headline">¶</a></h2>
<p>Using <a class="reference external" href="Whttp://hgomersall.github.io/pyFFTW/">PyFFTW</a> offers
substantial speed ups over Numpy&#8217;s FFT.</p>
<div class="code python highlight-python"><pre>a = np.random.random((1024, 16384))
b_numpy = np.fft.fftn(a, axes=(0, 1))
%timeit b_numpy = np.fft.fftn(a, axes=(0, 1))</pre>
</div>
<div class="highlight-python"><pre>1 loops, best of 3: 1.13 s per loop</pre>
</div>
<p>PyFFTW requires the creation of a &#8220;plan&#8221; in order to optimize the FFT.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">pyfftw</span>

<span class="n">input_array</span> <span class="o">=</span> <span class="n">pyfftw</span><span class="o">.</span><span class="n">n_byte_align_empty</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&#39;complex128&#39;</span><span class="p">)</span>
<span class="n">output_array</span> <span class="o">=</span> <span class="n">pyfftw</span><span class="o">.</span><span class="n">n_byte_align_empty</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&#39;complex128&#39;</span><span class="p">)</span>
<span class="n">fft_plan</span> <span class="o">=</span> <span class="n">pyfftw</span><span class="o">.</span><span class="n">FFTW</span><span class="p">(</span><span class="n">input_array</span><span class="p">,</span> <span class="n">output_array</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="n">Nproc</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">direction</span><span class="o">=</span><span class="s">&#39;FFTW_FORWARD&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Much faster!</p>
<div class="code python highlight-python"><pre>input_array[:] = a;
b_fftw = fft_plan()
%timeit input_array[:] = a; b_fftw = fft_plan()</pre>
</div>
<div class="highlight-python"><pre>10 loops, best of 3: 172 ms per loop</pre>
</div>
<p>The return types and values are the same.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="k">print</span> <span class="n">b_fftw</span><span class="o">.</span><span class="n">dtype</span>
<span class="k">print</span> <span class="n">b_numpy</span><span class="o">.</span><span class="n">dtype</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">b_numpy</span><span class="p">,</span> <span class="n">b_fftw</span><span class="p">)</span>
</pre></div>
</div>
<p>As with Numexpr, threading does help for large arrays.</p>
<div class="code python highlight-python"><pre>for Nthread in range(1, Nproc + 1):
    fft_plan = pyfftw.FFTW(input_array, output_array, threads=Nthread, axes=(0, 1), direction='FFTW_FORWARD')
    print 'Nthread:',Nthread
    %timeit input_array[:] = a; b_fftw = fft_plan()</pre>
</div>
<div class="highlight-python"><pre>Nthread: 1
1 loops, best of 3: 376 ms per loop
Nthread: 2
1 loops, best of 3: 224 ms per loop
Nthread: 3
10 loops, best of 3: 184 ms per loop
Nthread:</pre>
</div>
<div class="highlight-python"><pre>---------------------------------------------------------------------------
KeyboardInterrupt                         Traceback (most recent call last)

&lt;ipython-input-68-13bbe607deac&gt; in &lt;module&gt;()
      2     fft_plan = pyfftw.FFTW(input_array, output_array, threads=Nthread, axes=(0, 1), direction='FFTW_FORWARD')
      3     print 'Nthread:',Nthread
----&gt; 4     get_ipython().magic(u'timeit input_array[:] = a; b_fftw = fft_plan()')


/home/wd15/git/ipython/IPython/core/interactiveshell.pyc in magic(self, arg_s)
   2181         magic_name, _, magic_arg_s = arg_s.partition(' ')
   2182         magic_name = magic_name.lstrip(prefilter.ESC_MAGIC)
-&gt; 2183         return self.run_line_magic(magic_name, magic_arg_s)
   2184
   2185     #-------------------------------------------------------------------------


/home/wd15/git/ipython/IPython/core/interactiveshell.pyc in run_line_magic(self, magic_name, line)
   2102                 kwargs['local_ns'] = sys._getframe(stack_depth).f_locals
   2103             with self.builtin_trap:
-&gt; 2104                 result = fn(*args,**kwargs)
   2105             return result
   2106


/home/wd15/git/ipython/IPython/core/magics/execution.pyc in timeit(self, line, cell)


/home/wd15/git/ipython/IPython/core/magic.pyc in &lt;lambda&gt;(f, *a, **k)
    189     # but it's overkill for just that one bit of state.
    190     def magic_deco(arg):
--&gt; 191         call = lambda f, *a, **k: f(*a, **k)
    192
    193         if callable(arg):


/home/wd15/git/ipython/IPython/core/magics/execution.pyc in timeit(self, line, cell)
    984             number = 1
    985             for _ in range(1, 10):
--&gt; 986                 if timer.timeit(number) &gt;= 0.2:
    987                     break
    988                 number *= 10


/usr/lib/python2.7/timeit.pyc in timeit(self, number)
    193         gc.disable()
    194         try:
--&gt; 195             timing = self.inner(it, self.timer)
    196         finally:
    197             if gcold:


&lt;magic-timeit&gt; in inner(_it, _timer)


KeyboardInterrupt:</pre>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="mi">4</span>
</pre></div>
</div>
</div>
<div class="section" id="exercise-06-01">
<h2>Exercise 06-01<a class="headerlink" href="#exercise-06-01" title="Permalink to this headline">¶</a></h2>
<p>Identify the bottle necks in the <tt class="docutils literal"><span class="pre">MKSRegressionModel</span></tt> using the
<tt class="docutils literal"><span class="pre">line_profiler</span></tt> and improve things with Numexpr and PyFFTW. Plot the
relative speed up versus <tt class="docutils literal"><span class="pre">Nbin</span></tt>.</p>
<ul class="simple">
<li>start by subclassing <tt class="docutils literal"><span class="pre">MKSRegressionModel</span></tt> and then speed up the
<tt class="docutils literal"><span class="pre">predict</span></tt> method</li>
</ul>
</div>
<div class="section" id="fastmksregressionmodel">
<h2><tt class="docutils literal"><span class="pre">FastMKSRegressionModel</span></tt><a class="headerlink" href="#fastmksregressionmodel" title="Permalink to this headline">¶</a></h2>
<p>Using Numexpr and PyFFTW, we can make improvements to the
<tt class="docutils literal"><span class="pre">MKSRegressionModel</span></tt>. The <tt class="docutils literal"><span class="pre">FastMKSRegressionModel</span></tt> overwrites a
number of methods in <tt class="docutils literal"><span class="pre">MKSRegressionModel</span></tt>. <tt class="docutils literal"><span class="pre">FastMKSRegressionModel</span></tt>
only improves the <tt class="docutils literal"><span class="pre">predict</span></tt> method, not the <tt class="docutils literal"><span class="pre">fit</span></tt> method.</p>
<p>and it can be tested</p>
<p>Let&#8217;s compare the two classes.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
<span class="n">X0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">))</span>

<span class="n">fast_model</span> <span class="o">=</span> <span class="n">FastMKSRegressionModel</span><span class="p">(</span><span class="n">Nbin</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">slow_model</span> <span class="o">=</span> <span class="n">MKSRegressionModel</span><span class="p">(</span><span class="n">Nbin</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">fast_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">fast_model</span><span class="o">.</span><span class="n">resize_coeff</span><span class="p">(</span><span class="n">X0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
<span class="n">y_fast</span> <span class="o">=</span> <span class="n">fast_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X0</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

<span class="n">slow_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">slow_model</span><span class="o">.</span><span class="n">resize_coeff</span><span class="p">(</span><span class="n">X0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
<span class="n">y_slow</span> <span class="o">=</span> <span class="n">fast_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X0</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

<span class="k">print</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">y_fast</span><span class="p">,</span> <span class="n">y_slow</span><span class="p">)</span>
</pre></div>
</div>
<p>They give the same result, but what about efficiency gains.</p>
<div class="code python highlight-python"><pre>%timeit slow_model.predict(X0.copy())</pre>
</div>
<div class="code python highlight-python"><pre>%timeit fast_model.predict(X0.copy())</pre>
</div>
<p>This is better for small <tt class="docutils literal"><span class="pre">Nbin</span></tt> at the moment. Plot of speed up versus
<tt class="docutils literal"><span class="pre">Nbin</span></tt>.</p>
</div>
<div class="section" id="comparing-mks-and-fipy">
<h2>Comparing MKS and FiPy<a class="headerlink" href="#comparing-mks-and-fipy" title="Permalink to this headline">¶</a></h2>
<div class="code python highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">clear_output</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">pymks</span> <span class="kn">import</span> <span class="n">FiPyCHModel</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">41</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
<span class="n">phi0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">FastMKSRegressionModel</span><span class="p">(</span><span class="n">Nbin</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">resize_coeff</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

<span class="n">fipymodel</span> <span class="o">=</span> <span class="n">FiPyCHModel</span><span class="p">()</span>
<span class="n">fipy_phi1</span> <span class="o">=</span> <span class="n">phi0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">mks_phi1</span> <span class="o">=</span> <span class="n">phi0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">steps</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">dt</span><span class="o">=</span><span class="mf">1e-8</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
    <span class="n">fipy_response</span> <span class="o">=</span> <span class="n">fipymodel</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">fipy_phi1</span><span class="p">)</span>
    <span class="n">mks_response</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">mks_phi1</span><span class="p">)</span>
    <span class="c">#Euler forward</span>
    <span class="n">fipy_phi1</span> <span class="o">=</span> <span class="n">fipy_response</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">+</span> <span class="n">fipy_phi1</span>
    <span class="n">mks_phi1</span> <span class="o">=</span> <span class="n">mks_response</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">+</span> <span class="n">mks_phi1</span>
    <span class="n">mks_phi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">mks_phi1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">mks_phi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">mks_phi1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c">#print phi0</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;FiPy&#39;</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">fipy_phi1</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">)),</span> <span class="n">vmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;MKS&#39;</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mks_phi1</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">)),</span> <span class="n">vmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">clear_output</span><span class="p">()</span>
    <span class="n">display</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">i</span>
</pre></div>
</div>
<img alt="../_images/improving_performance_79_0.png" src="../_images/improving_performance_79_0.png" />
<div class="highlight-python"><pre>---------------------------------------------------------------------------
KeyboardInterrupt                         Traceback (most recent call last)

&lt;ipython-input-70-a62898ae6a1c&gt; in &lt;module&gt;()
     18 dt=1e-8
     19 for i in range(steps):
---&gt; 20     fipy_response = fipymodel.predict(fipy_phi1)
     21     mks_response = model.predict(mks_phi1)
     22     #Euler forward


/home/wd15/git/pymks/pymks/fipyCHModel.pyc in predict(self, X)
     31             phi[:] = x.flatten()
     32             phi.updateOld()
---&gt; 33             self._solve(eq, phi, LinearLUSolver(), self.dt)
     34             #            eq.solve(phi, dt=self.dt, solver=LinearLUSolver())
     35             phi_ij = np.array(phi).reshape((nx, ny))


/home/wd15/git/pymks/pymks/fipyCHModel.pyc in _solve(self, eq, phi, solver, dt)
     42
     43         for sweep in range(5):
---&gt; 44             res = eq.sweep(phi, dt=dt, solver=LinearLUSolver())
     45             #    print 'res',res
     46


/home/wd15/git/fipy/fipy/terms/term.pyc in sweep(self, var, solver, boundaryConditions, dt, underRelaxation, residualFn, cacheResidual, cacheError)
    234
    235         """
--&gt; 236         solver = self._prepareLinearSystem(var=var, solver=solver, boundaryConditions=boundaryConditions, dt=dt)
    237         solver._applyUnderRelaxation(underRelaxation=underRelaxation)
    238         residual = solver._calcResidual(residualFn=residualFn)


/home/wd15/git/fipy/fipy/terms/term.pyc in _prepareLinearSystem(self, var, solver, boundaryConditions, dt)
    166                                                            boundaryConditions=boundaryConditions,
    167                                                            dt=dt,
--&gt; 168                                                            transientGeomCoeff=self._getTransientGeomCoeff(var),
    169                                                            diffusionGeomCoeff=self._getDiffusionGeomCoeff(var),
    170                                                            buildExplicitIfOther=self._buildExplcitIfOther)


/home/wd15/git/fipy/fipy/terms/binaryTerm.pyc in _getTransientGeomCoeff(self, var)
     94
     95     def _getTransientGeomCoeff(self, var):
---&gt; 96         return self._addNone(self.term._getTransientGeomCoeff(var), self.other._getTransientGeomCoeff(var))
     97
     98     def _getDiffusionGeomCoeff(self, var):


/home/wd15/git/fipy/fipy/terms/transientTerm.pyc in _getTransientGeomCoeff(self, var)
    144         """
    145         if var is self.var or self.var is None:
--&gt; 146             return self._getGeomCoeff(var)
    147         else:
    148             return None


/home/wd15/git/fipy/fipy/terms/term.pyc in _getGeomCoeff(self, var)
    463     def _getGeomCoeff(self, var):
    464         if self.geomCoeff is None:
--&gt; 465             self.geomCoeff = self._calcGeomCoeff(var)
    466             if self.geomCoeff is not None:
    467                 self.geomCoeff.dontCacheMe()


/home/wd15/git/fipy/fipy/terms/transientTerm.pyc in _calcGeomCoeff(self, var)
    116             return self.coeff[...,numerix.newaxis] * numerix.resize(var.mesh.cellVolumes, var.shape)
    117         else:
--&gt; 118             return self.coeff * numerix.resize(var.mesh.cellVolumes, var.shape)
    119
    120     def _getTransientGeomCoeff(self, var):


/home/wd15/git/fipy/fipy/variables/variable.pyc in __mul__(self, other)
   1149             return other * self
   1150         else:
-&gt; 1151             return self._BinaryOperatorVariable(lambda a,b: a*b, other)
   1152
   1153     __rmul__ = __mul__


/home/wd15/git/fipy/fipy/variables/variable.pyc in _BinaryOperatorVariable(self, op, other, operatorClass, opShape, canInline, unit)
   1123
   1124         return binOp(op=op, var=[self, other], opShape=opShape, canInline=canInline, unit=unit,
-&gt; 1125                      inlineComment=inline._operatorVariableComment(canInline=canInline))
   1126
   1127     def __add__(self, other):


/home/wd15/git/fipy/fipy/variables/operatorVariable.pyc in __init__(self, op, var, opShape, canInline, unit, inlineComment, *args, **kwargs)
     52             self.name = ''
     53             for var in self.var:    #C does not accept units
---&gt; 54                 if not var.unit.isDimensionless():
     55                     self.canInline = False
     56                     break


/home/wd15/git/fipy/fipy/variables/variable.pyc in _getUnit(self)
    253             &lt;PhysicalUnit m&gt;
    254         """
--&gt; 255         return self._extractUnit(self.value)
    256
    257     @getsetDeprecated


/home/wd15/git/fipy/fipy/variables/variable.pyc in _getValue(self)
    545             value = self._value
    546
--&gt; 547         if len(self.constraints) &gt; 0:
    548             value = value.copy()
    549             for constraint in self.constraints:


/home/wd15/git/fipy/fipy/variables/variable.pyc in constraints(self)
    570     value = property(_getValue, _setValueProperty)
    571
--&gt; 572     @property
    573     def constraints(self):
    574         if not hasattr(self, "_constraints"):


KeyboardInterrupt:</pre>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="mi">1</span>
</pre></div>
</div>
<img alt="../_images/improving_performance_79_3.png" src="../_images/improving_performance_79_3.png" />
</div>
<div class="section" id="simulation">
<h2>Simulation<a class="headerlink" href="#simulation" title="Permalink to this headline">¶</a></h2>
<p>A full simulation. The MKS has to artificially maintain the solution
between 0 and 1. This hasn&#8217;t been fixed yet.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
<span class="n">X0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">1e-8</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">FastMKSRegressionModel</span><span class="p">(</span><span class="n">Nbin</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">resize_coeff</span><span class="p">(</span><span class="n">X0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">X1</span> <span class="o">=</span> <span class="n">X0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">steps</span> <span class="o">=</span> <span class="mi">3000</span>
<span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X1</span><span class="p">)</span>
    <span class="n">X1</span> <span class="o">=</span> <span class="n">numexpr</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="s">&#39;X1 + dt * y1&#39;</span><span class="p">)</span>
    <span class="n">X1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">X1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">X1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">X1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">step</span> <span class="o">%</span> <span class="p">(</span><span class="n">steps</span> <span class="o">/</span> <span class="mi">200</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">print</span> <span class="n">step</span><span class="p">,</span>
</pre></div>
</div>
<div class="highlight-python"><pre>0 15 30 45 60 75 90 105 120 135 150 165 180 195 210 225 240 255 270 285 300 315 330 345 360 375 390 405 420 435 450 465 480 495 510 525 540 555 570 585 600 615 630 645 660 675 690 705 720 735 750 765 780 795 810 825 840 855 870 885 900 915 930 945 960 975 990 1005 1020 1035 1050 1065 1080 1095 1110 1125 1140 1155 1170 1185 1200 1215 1230 1245 1260 1275 1290 1305 1320 1335 1350 1365 1380 1395 1410 1425 1440 1455 1470 1485 1500 1515 1530 1545 1560 1575 1590 1605 1620 1635 1650 1665 1680 1695 1710 1725 1740 1755 1770 1785 1800 1815 1830 1845 1860 1875 1890 1905 1920 1935 1950 1965 1980 1995 2010 2025 2040 2055 2070 2085 2100 2115 2130 2145 2160 2175 2190 2205 2220 2235 2250 2265 2280 2295 2310 2325 2340 2355 2370 2385 2400 2415 2430 2445 2460 2475 2490 2505 2520 2535 2550 2565 2580 2595 2610 2625 2640 2655 2670 2685 2700 2715 2730 2745 2760 2775 2790 2805 2820 2835 2850 2865 2880 2895 2910 2925 2940 2955 2970 2985 3000</pre>
</div>
<div class="section" id="rudimentary-animation-of-the-data">
<h3>Rudimentary Animation of the Data<a class="headerlink" href="#rudimentary-animation-of-the-data" title="Permalink to this headline">¶</a></h3>
<div class="code python highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">clear_output</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">()</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">X0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">vmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
    <span class="n">a</span><span class="o">.</span><span class="n">set_array</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">clear_output</span><span class="p">()</span>
    <span class="n">display</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="java-script-animation-of-the-data">
<h3>Java Script Animation of the Data<a class="headerlink" href="#java-script-animation-of-the-data" title="Permalink to this headline">¶</a></h3>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># JSAnimation import available at https://github.com/jakevdp/JSAnimation</span>
<span class="kn">from</span> <span class="nn">JSAnimation</span> <span class="kn">import</span> <span class="n">IPython_display</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">animation</span>

<span class="c"># create a simple animation</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">()</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">X0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">init</span><span class="p">():</span>
    <span class="n">im</span><span class="o">.</span><span class="n">set_array</span><span class="p">(</span><span class="n">X0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">im</span>

<span class="k">def</span> <span class="nf">animate</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
    <span class="n">im</span><span class="o">.</span><span class="n">set_array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">im</span>

<span class="n">anim</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">animate</span><span class="p">,</span> <span class="n">init_func</span><span class="o">=</span><span class="n">init</span><span class="p">,</span>
                               <span class="n">frames</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">interval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">blit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">HTML</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">anim</span><span class="o">.</span><span class="n">_fig</span><span class="p">)</span>
<span class="n">HTML</span><span class="p">(</span><span class="n">IPython_display</span><span class="o">.</span><span class="n">anim_to_html</span><span class="p">(</span><span class="n">anim</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.<br/>
    </p>
  </div>
</footer>
  </body>
</html>